%% Filter out bad/false detections
clear all

load transienttemplate.mat
load transienttemplate2.mat

%% Extract detections

limerrx=5
region='SVI'

addpath('/home/savardge/hypfiles/VI/')
addpath('/home/savardge/hypfiles/VI/interETS')
dir1='/home/savardge/hypfiles/VI/interETS/'

% SELECT EVENTS

% % InterETS
events=char(importdata(['/home/savardge/hypfiles/VI/','interETS_events.dat']));
events=events(:,4:end-2);
ind1=find(strncmp('05',cellstr(events),2),1,'first');
% ind2=find(strncmp('031230',cellstr(events),6));
% events=events(ind1:ind2,:)
events=events(ind1:end,:)
% 
% SVI 2005
%  events=['050906';'050907';'050908'; '050909';'050910'; '050911'; '050912';'050913';'050914';'050915'; '050916'; '050917'; '050918';'050919'; '050920'; '050921';'050922'; '050923'; '050924']; % '050925'];
%  events=['050917'; '050918'; '050919'; '050920'; '050921'];
% events=[ '050912'; '050913'; '050914'];'040713';'040714';'040716''050903'; '050904'; '050905'; '050906'; '050907'

% SVI 2003
% events=['030226';'030227';'030228';'030301';'030302';'030303';'030304' ;'030305' ; '030306'; '030307'; '030308'; '030309';'030310';'030311'];%'040713';'040714';'040715';'040716';'040717';'040718';'040719'; '050911'; '050912'; '050913'; '050914'; '050915'; '050916']; %'040720';'040721';'040722'; '040723';'040724';'040725';'040726'] %;'040727'];

% SVI 2004
%  events=['040712';'040713';'040714';'040715';'040716';'040717';'040718';'040719';'040720';'040721';'040722';'040723';'040724']
% events=['040710';'040711';'040712';'040713';'040714';'040715';'040716';'040717';'040718';'040719';'040720';'040721'; '040722'; '040723';'040724';'040725']; %'040726';'040727'];
%  events=['040720'; '040721'; '040722'; '040723';'040724';'040725';'040726';'040727'];
%  events= ['040716';'040717']; %'040718';'040719';'040720']
% event='040719'

% SVI 2013
% events=['130913';'130914';'130915';'130916';'130917';'130918';'130919';'130920';'130921';'130922';'130923';'130924';'130925';'130926';'130927';'130928';'131001';'131002';'131003';'131004';'131005';'131006';'131001';'131002';'131003' ;'131004';'131005';'131006';'131007';'131009';'131010';'131011';'131012';'131013'];

% NVI
%  events=['060905';'060906';'060907';'060908';'060909';'060910';'060911']; %'070301';'070302';'070303'];
%  events=['070228';'070301';'070302';'070303'];%'070613';'070614';'070615';'070616'];
% events=['070616';'070617';'070618']
%  events=['060905';'060906';'060907';'060908';'060909';'060910'];%'060911']; %'070228';'070301';'070302';'070303'; '070613';'070614';'070615';'070616';'070617';'070618']; %'080915';'080916';'080917';'090222';'090223'];
%  events=['070301';'070302';'070303']
% events=['100419';'100421']
% events='070615' ; %['100418';'100419';'100420';'100421';'100422']

% NW 2010
% events=['100811';'100812';'100813';'100814';'100815';'100816';'100817';'100818';'100819';'100820'];
%  events=['100812']; % '100808'; '100809'; '100810'; '100811'; '100812'; '100813'; '100814'; '100815'; '100816'; '100817'; '100818'; '100819'; '100820'; '100821'; '100822'; '100823'; '100824'];
% NW 2011
%events=['110804'; '110805'; '110806'; '110807'; '110808'; '110809'; '110810'; '110811'; '110812'; '110813'; '110814'; '110815'; '110816'; '110817'; '110818'; '110819'; '110820'; '110821'; '110822'; '110823'];
% events=['110808'; '110809'; '110810'; '110811'; '110812'; '110813'; '110814'; '110815'; '110816'; '110817'; '110818'; '110819'; '110820'; '110821'; '110822'; '110823'];
% events='110810'
% events=['110808'; '110809'; '110810'; '110811'; '110812'; '110813'; '110814'; '110815'; '110816'; '110817'; '110818'; '110819'; '110820'; '110821'; '110822'; '110823'];
% NW 2008
% events=(['080501';'080502';'080503';'080504';'080505';'080506';'080507';'080508';'080509';'080510';'080511';'080512';'080513';'080514';'080515';'080516';'080517'])
% NW 2007
% events=['070112';'070113';'070114';'070115';'070116';'070117';'070118';'070119';'070120';'070121';'070122';'070123';'070124';'070125';'070126';'070127';'070128';'070129';'070130']
% '070112'['070113'
% NW 2009
% events=['090501';'090502';'090503';'090504';'090505';'090506';'090507';'090508';'090509';'090510';'090511']; %'090512';'090513';'090514';'090515';'090516';'090517';'090518';'090519';'090520']
% NW all
% events=['090501';'090502';'090503';'090504';'090505';'090506';'090507';'090508';'090509';'090510';'090511';'090512';'090513';'090514';'090515';'090516';'090517';'090518';'090519';'090520';'070112';'070113';'070114';'070115';'070116';'070117';'070118';'070119';'070120';'070121';'070122';'070123';'070124';'070125';'070126';'070127';'070128';'070129';'070130';'080501';'080502';'080503';'080504';'080505';'080506';'080507';'080508';'080509';'080510';'080511';'080512';'080513';'080514';'080515';'080516';'080517';'110808'; '110809'; '110810'; '110811'; '110812'; '110813'; '110814'; '110815'; '110816'; '110817'; '110818'; '110819'; '110820'; '110821'; '110822'; '110823'; '100808'; '100809'; '100810'; '100811'; '100812'; '100813'; '100814'; '100815'; '100816'; '100817'; '100818'; '100819'; '100820'; '100821'; '100822'; '100823'; '100824']

% SW
% events=['070112';'070113';'070114';'070115';'070116';'070117';'070118';'070119';'070120';'070121';'070122';'070123';'070124';'070125';'070126';'070127';'070128';'070129';'070130']


for k=1:size(events,1)
    event=events(k,:)
    eval(['ll_',event]);
    
    time=[];
    elat=[];
    elon=[];
    edep=[];
    enum=[];
    eerrx=[];
    eerrz=[];
    allines=[];
    
    if ~isempty(A)
        allines=[allines ; A];
        etime=A(:,1);
        stime=num2str(etime);
        yr=str2num(stime(:,1:4));
        mo=str2num(stime(:,5:6));
        da=str2num(stime(:,7:8));
        hr=str2num(stime(:,9:10));
        mn=str2num(stime(:,11:12));
        se=str2num(stime(:,13:16))/100;
        time=[time; datenum(yr,mo,da,hr,mn,se)];
        elat=[elat ; A(:,2)];
        elon=[elon ; A(:,3)];
        edep=[edep ; A(:,4)];
        enum=[enum ; A(:,5)];
        eerrx=[eerrx ; A(:,6)];
        %         eerrz=[eerrz ; A(:,7)];
    else
        disp('empty')
    end
    
    
    disp('Total number of detections: ')
    length(eerrx)
    id=find(eerrx < limerrx );%& (elon < maxlon & elon>minlon) & (elat < maxlat & elat>minlat) );
    elat=elat(id);
    elon=elon(id);
    time=time(id);
    edep=edep(id);
    eerrx=eerrx(id);
    allines=allines(id,:);
    disp(['Number of observations errx < ' num2str(limerrx) ' km'])
    N=length(id);
    
    timevec=datevec(time);
    
    %% Remove detections with transients
    
    bestlines=[];
%     x=[]; y=[]; utmzone=[]; errh=[];
    for ik=1:N
        disp(['Iteration ',num2str(ik),' of ',num2str(N)])
        [ ncomp,ecomp,zcomp, ordlst, HorizErr ] = extractDetection( timevec(ik,1),timevec(ik,2),timevec(ik,3), timevec(ik,4), timevec(ik,5), timevec(ik,6), 0, dir1);
        disp('Detection extracted')
        ns=size(ncomp,1);
        flagbad=0; % 0 if detection good, 1 if bad
        
        for is=1:ns
            % Template 1 -------------------------------------------------
            ccfn = ccfnew(template,ncomp(is,:));
            ccfe = ccfnew(template,ecomp(is,:));
            
            if max(abs(ccfn))>0.95 || max(abs(ccfe))>0.95
                disp(['Transient at station ',num2str(is),' --> False detection'])
                flagbad=1;
                break
            end
            % ------------------------------------------------------------
            % inverse template 1
            ccfn = ccfnew(-template,ncomp(is,:));
            ccfe = ccfnew(-template,ecomp(is,:));
            
            if max(abs(ccfn))>0.95 || max(abs(ccfe))>0.95
                disp(['Transient at station ',num2str(is),' --> False detection'])
                flagbad=1;
                break
            end
            % ------------------------------------------------------------
             % template 2
            ccfn = ccfnew(template2,ncomp(is,:));
            ccfe = ccfnew(template2,ecomp(is,:));
            
            if max(abs(ccfn))>0.95 || max(abs(ccfe))>0.95
                disp(['Transient at station ',num2str(is),' --> False detection'])
                flagbad=1;
                break
            end
            % ------------------------------------------------------------
             % inverse template 2 ----------------------------------------
            ccfn = ccfnew(-template2,ncomp(is,:));
            ccfe = ccfnew(-template2,ecomp(is,:));
            
            if max(abs(ccfn))>0.95 || max(abs(ccfe))>0.95
                disp(['Transient at station ',num2str(is),' --> False detection'])
                flagbad=1;
                break
            end
            % -------------------------------------------------------------
            % Check spectrum 
            [S,f]=periodogram(ncomp(is,:),[],'onesided',size(ncomp,2),40);
            if (sum(S(f<2).*f(f<2))/sum(f.*S)*100)>50
                disp('Too much low frequency')
                flagbad=1;
                break
            end
        end
        
        if flagbad==0
            disp('True')
            [xdum,ydum,utm]=deg2utm(elat(ik),elon(ik));
            
            bestlines=[bestlines ; allines(ik,:)];
%             utmzone=[utmzone;utm];
%             x=[x ; xdum];
%             y=[y ; ydum];
%             errh=[errh ; HorizErr];
        else
            disp('False')
            
        end
        
        
        
    end
    A=bestlines;
    save(['ll_',event,'_cleaned.mat'],'A')
    
    
    
end